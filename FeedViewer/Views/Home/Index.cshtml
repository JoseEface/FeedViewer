@model FeedViewer.Models.LoginInfo
@{
    ViewBag.Title = "Bem-vindo ao FeedViewer!";
    
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";  //Chame somente depois de iniciar ViewBag
}

@section AreaHead {
    <style>

        .adicional {
            background: #fafafa;
        }

        .adicionalrow {
            margin-bottom: 2%;
        }

        .adicionalrowbaixo {
            margin-bottom: 2%;
        }

        .adicionalrowsup {
            margin-top: 2%;
        }


        #contpaginacao {
            border-top: 1px solid lightgray;
            border-bottom: 1px solid lightgray;
        }

        td {
            padding: 1%;
        }

        .estilizaImagem {
            width: 46px;
            margin: -8px -11px;
        }

        div.title {
            font-weight: bold;
            padding-bottom: 1%;
            padding-top: 1%;
        }

        @@media screen and (min-device-width: 700px) {
            .col-xs-6 {
                margin-top: 2%;
                
            }
            
            .adicionalrow {
                margin-bottom: 0;
            }

            .adicionalrowsup {
                margin-top: 2%;
            }

        }
    </style>
}


@section AreaConteudo {

    <div class="row">
        <div class="col-md-12 col-sm-12 col-xs-12">
            <div class="x_panel">
                <div class="x_title">
                    <h2>FeedViewer <small>detalhes de seus RSS feeds</small></h2>
                    <ul class="nav navbar-right panel_toolbox">
                        <li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
                        </li>
                    </ul>
                    <div class="clearfix"></div>
                </div>
                <div class="x_content">
                    <h3>Olá 
                        @if (Model != null)
                            {
                                Write(Model.Usuario.nome); 
                            }
                        !
                    </h3>
                    <br />
                    <p>Essa é sua página inicial.</p>
                    <p>Aproveite para ver se houveram novas alterações nos seus RSS Feeds.</p>
                    <br />
                    <h5><b>Consulte seus RSS feeds favoritos:</b></h5>
                    <div id="contpaginacao">
                        <div id="conteudopagina">
                        
                        <!--
                        <div class="row">

                            <div class="col-sm-3 col-xs-6">
                                <a href="javascript:void(0);">
                                    <div class="media event adicional">

                                        <div class="pull-left border-aero profile_thumb">
                                            <img src="http://www.google.com/s2/favicons?domain=www.google.com" class="img-circle estilizaImagem"/>
                                        </div>
                                        <div class="media-body">
                                            <div class="title">Ms. Mary Jane</div>
                                            
                                            <p><strong>2300 </strong> pessoa(s) utilizando </p>
                                            
                                        </div>

                                    </div>
                                </a>
                            </div>


                        </div>
                        <div class="adicionalrow"></div>
                        -->


                        </div>
                        <div class="adicionalrowbaixo"></div>

                       
                    </div>
                    <form method="post" action="." class="form-horizontal form-label-left">
                        <div class="row">
                        <div class="col-sm-6" style="margin-top: 18px;">
                            <label class="col-sm-3" style="padding: 8px; margin-left: 0; padding-left: 0;">Filtrar por</label>
                            <input class="col-sm-3" type="text" style="height: 35px; width: 100px;" id="txtfiltrar">
                            &nbsp
                            <input type="button" class="btn btn-success" value="Filtrar" id="btnfiltrar" />
                            <input type="button" class="btn btn-success" value="Limpar filtro" id="btnlimpafiltro" onclick="javascript:limpaFiltro()" />
                        </div>
                        <div class="col-sm-6">
                            <div class="pagination pull-right" id="paginacao">
                                <a href="#" class="first btn btn-success" data-action="first"><i class="glyphicon glyphicon-backward"></i></a>
                                <a href="#" class="previous btn btn-success" data-action="previous"><i class="glyphicon glyphicon-chevron-left"></i></a>
                                    <input class="" type="text" readonly="readonly" id="maxpagina" style="height: 35px; text-align: center; font-size: 16px;" />
                                <a href="#" class="next btn btn-success" data-action="next"><i class="glyphicon glyphicon-chevron-right"></i></a>
                                <a href="#" class="last btn btn-success" data-action="last"><i class="glyphicon glyphicon-forward"></i></a>
                            </div>
                        </div>
                            </div>
                    </form>


                </div> <!-- fim conteudo panel -->

        </div>
    </div>
</div>

<br />

<div class="row" id="mostraDetalhe">
        <div class="col-md-12 col-sm-12 col-xs-12">
            <div class="x_panel" id="DetalheRSS">
                <div class="x_title">
                    <h2>RSS Feed <small>detalhes do rss</small></h2>
                    <ul class="nav navbar-right panel_toolbox">
                        <li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
                        </li>
                    </ul>
                    <div class="clearfix"></div>
                </div>
                <div class="x_content">
                    <h3>Detalhes de: <span id="feednome"> </span></h3>
                    <p>Mostrando as três últimas movimentações, para ver todas clique no botão ver todas as movimentações do RSS: </p>
                    <button class="btn btn-success pull-right" id="feedTodas" title="Exibe todas as movimentações do RSS">Todas as movimentações</button>
                    <input type="hidden" name="descId" id="descId" value="0" />
                    <div id="movimentacoesRSS" style="width: 100%; height: 250px; clear: both; border: 1px solid #e6e9ed; overflow-y: scroll;">

                    </div>
                    <br />
                </div>
            </div>
        </div>
</div>

    <br />
    
}

@section AreaScript {
    <script src="http://beneverard.github.io/jqPagination/js/jquery.jqpagination.js?versao=@DateTime.Now.Millisecond"></script>
    <script type="text/javascript">

        var filtroGlobal = "";

        function limpaVisualizacao() {
            $("#descId").val(0);
            $("#movimentacoesRSS").html();
        }

        function VisualizaRSS(id, nome, qtd) {
            //alert("Estou vendo o RSS Feed " + id + nome);

            $("#movimentacoesRSS").html("<img src=\"" + "http://www.arabianbusiness.com/skins/ab.main/gfx/loading_spinner.gif" + "\" style=\"margin-left: 40%;margin-top: 2%;\"></img>");
            $("#descId").val(0);
            $("html, body").animate({ scrollTop: $("#mostraDetalhe").offset().top }, 1000);
            $("#feednome").html("");
            $.ajax({
                type: "post",
                url: "@Url.Action("Detalhes", "RSSFeed")",
                dataType: "json",
                data: { "id": id, "maxnot": qtd },
                success: function (dados) {
                    //console.log(dados);
                    $("#feednome").html(nome);
                    $("#descId").val(id);
                    $("#movimentacoesRSS").html("");
                    if (dados.constructor == Array) {
                        var texto = "";

                        for (var x = 0; x < dados.length; x++) {
                            texto = "<dl> \
                                       <dt><b>"+ dados[x].Title.Text + "</b></dt>\
                                          <dd>"+ dados[x].Summary.Text + "</dd> \
                                     </dl>";
                            $("#movimentacoesRSS").append(texto);
                        }
                    }
                    //console.log(dados);
                },
                error: function (req, erro, msg) {
                    alert("Erro na requisicao");
                    $("#movimentacoesRSS").html("");
                    console.log(req);
                    console.log(erro);
                    console.log(msg);
                }
            });
        }

        function preenchePaginador(dados,maxnumero) {
            var strfeeed = "                            \
                                <div class=\"col-sm-3  col-xs-6\" > \
                                    <a href=\"javascript:VisualizaRSS(#idrss,#nomeviz,3);\"> \
                                       <div class=\"media event adicional\">\
                                                <div class=\"pull-left border-aero profile_thumb\"> \
                                                <img src=\"http://www.google.com/s2/favicons?domain=#urlrss\" class=\"img-circle estilizaImagem\"/> \
                                            </div> \
                                            <div class=\"media-body\"> \
                                                <div class=\"title\">#nomerss</div> \
                                                <p><strong>#usnrss </strong> pessoa(s) utilizando </p>\
                                            </div>\
                                        </div> \
                                    </a>\
                                </div>";
            var i, j, k;
            var maxit = maxnumero / 3;
            var conteudo;
            $("#conteudopagina").html("");
            for (i = 0, j = 0; i < dados.length; i++) {
                var str = "<div class=\"row\">"; ///jquery append fecha divs automaticamente....
                for (j = 0; j < maxit && i < dados.length; j++, i++) {
                    conteudo = strfeeed;
                    conteudo = conteudo.replace("#idrss", "" + dados[i].id);
                    conteudo = conteudo.replace("#nomeviz", "" + "'" + dados[i].nome + "'");
                    conteudo = conteudo.replace("#urlrss", "" + dados[i].caminho);
                    conteudo = conteudo.replace("#nomerss", "" + dados[i].nome);
                    conteudo = conteudo.replace("#usnrss", "" + dados[i].usando);
                    str += conteudo;
                }
                i--;
                str += "</div>";
                $("#conteudopagina").append(str);
                $("#conteudopagina").append("<div class=\"adicionalrow\"></div>");
            }
        }

        function preenchePagina(pagina, maxnumero) {
            $.ajax({
                type: "post",
                dataType: "json",
                data: {"pagina": pagina, "maxnumero": maxnumero, "filtrado": filtroGlobal},
                url: "@Url.Action("pegaPagina","Home")",
                success: function (dados) {
                    //console.log(dados);
                    if (dados.constructor === Array) {
                        if (dados.length) {
                            preenchePaginador(dados, maxnumero);
                        }
                        else {
                            $("#conteudopagina").html("<br/><p>Nenhum valor foi encontrado</p><br/>");
                        }
                    }
                    else {
                        alert("Falha no formato retornado pelo servidor");
                        if (typeof console !== "undefined") {
                            console.log(dados);
                        }
                    }
                },
                error: function (req, erro, msg) {
                    alert("Erro na requisicao ao servidor");
                    $("#conteudopagina").html("<br/><p>Nenhum valor foi encontrado</p><br/>");
                    if (typeof console !== "undefined") {
                        console.log(req);
                        console.log(erro);
                        console.log(msg);
                    }
                }
            });
        }

        preenchePagina(1, 12);

        $("#feedTodas").click(function (e) {
            e.preventDefault();
            if ($("#descId").val() != "0") {
                VisualizaRSS($("#descId").val(), $("#feednome").html(), 0);
            }
            else
                alert("Nenhum RSS Feed atualmente carregado");
        });


        function IniciaPaginador(maxpagina) {
            $('#paginacao').jqPagination({
                max_page: maxpagina,
                paged: function (page) {
                    // do something with the page variable
                    //alert("lalala");
                    preenchePagina(page, 12);
                },
                page_string: " {current_page} de {max_page}"
            });
        }

        function rePagina() {
            $("#paginacao").jqPagination("option", "current_page", 1);
        }

        function limpaFiltro() {
            filtroGlobal = "";
            var temDados = false;
            $("#txtfiltrar").val("");
            $.ajax({
                type: "post",
                dataType: "json",
                data: {"filtrado":filtroGlobal},
                url: "@Url.Action("contaTotal","Home")",
                success: function (dados) {
                    if(dados == 0)
                    {
                        $("#conteudopagina").html("<br/><p>Nenhum valor foi encontrado</p><br/>");
                        $("#paginacao").jqPagination("option", "current_page", 1);
                        $("#paginacao").jqPagination("option", "max_page", 1);
                    }
                    else
                    {
                        var qtd = parseInt(dados / 9);
                        if (dados & 9 > 0) qtd++;
                        if (qtd == 0) qtd++;
                        $("#paginacao").jqPagination("option", "current_page", 1);
                        $("#paginacao").jqPagination("option", "max_page", qtd);
                        temDados = true;
                    }
                },
                error: function (req,erro,msg) {
                    alert("Falha na requisicao ao servidor");
                    if(typeof console != "undefined") {
                        console.log(req);
                        console.log(erro);
                        console.log(msg);
                    }
                },
                async: false
            });
            if(temDados)
                preenchePagina(1,12);
        }
        
        function defineFiltro(filtro) {
            filtroGlobal = filtro;
            var temDados = false;
            $.ajax({
                type: "post",
                dataType: "json",
                data: { "filtrado": filtroGlobal },
                url: "@Url.Action("contaTotal","Home")",
                success: function (dados) {
                    if (dados == 0) {
                        $("#conteudopagina").html("<br/><p>Nenhum valor foi encontrado</p><br/>");
                        $("#paginacao").jqPagination("option", "current_page", 1);
                        $("#paginacao").jqPagination("option", "max_page", 1);
                        $("#paginacao").jqPagination("option", "current_page", 1);
                    }
                    else {
                        var qtd = parseInt(dados / 9);                        
                        if (dados & 9 > 0) qtd++;
                        if (qtd == 0) qtd++;
                        $("#paginacao").jqPagination("option", "current_page", 1);
                        $("#paginacao").jqPagination("option", "max_page", qtd);
                        $("#paginacao").jqPagination("option", "current_page", 1);                        
                        temDados = true;
                    }
                },
                error: function (req, erro, msg) {
                    alert("Falha na requisicao ao servidor");
                    if (typeof console != "undefined") {
                        console.log(req);
                        console.log(erro);
                        console.log(msg);
                    }
                },
                async: false
            });
            if (temDados)
                preenchePagina(1, 12);
        }

        $("#btnfiltrar").click(function (e) {
            e.preventDefault();
            defineFiltro($("#txtfiltrar").val());
        });

        var paginaMaximaInicia = "@{   if (ViewBag.qtdSeguindo > 0)
                                     {
                                        Write(""+((ViewBag.qtdSeguindo / 9) + ( (ViewBag.qtdSeguindo % 9) > 0 ? 1 : 0)));
                                     }
                                     else{
                                        Write("1");
                                     }
                                 }";
        IniciaPaginador(paginaMaximaInicia);
        
    </script>
}